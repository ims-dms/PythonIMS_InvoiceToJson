# System Architecture & Data Flow

## Complete System Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CLIENT APPLICATION                              â”‚
â”‚                                                                           â”‚
â”‚  User uploads invoice PDF/Image â†’ POST /extract                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FASTAPI SERVER (api.py)                          â”‚
â”‚                                                                           â”‚
â”‚  1. Receive uploaded file                                                â”‚
â”‚  2. Convert PDF to image (if needed)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      GEMINI AI OCR PROCESSING                            â”‚
â”‚                                                                           â”‚
â”‚  Extract structured data from invoice:                                   â”‚
â”‚  â€¢ Invoice metadata (invoice_no, date, dealer_name, etc.)                â”‚
â”‚  â€¢ Product list with SKU descriptions                                    â”‚
â”‚  â€¢ Quantities, rates, batch numbers, etc.                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                          OCR Result JSON
                    {
                      "products": [
                        {
                          "sku": "LACTOGEN PRO1 BIB 24x400g...",
                          "sku_code": "12579462",
                          "quantity": 5,
                          ...
                        }
                      ]
                    }
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATABASE QUERY (db_connection.py)                     â”‚
â”‚                                                                           â”‚
â”‚  SELECT desca, mcode FROM menuitem                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                      Check Cache (menu_cache.py)
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                         â”‚
              Cache Hit (<1ms)          Cache Miss (1-2s)
                    â”‚                         â”‚
                    â”‚                         â–¼
                    â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚              â”‚  Query Database      â”‚
                    â”‚              â”‚  Load 700k items     â”‚
                    â”‚              â”‚  Store in cache      â”‚
                    â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                        Menu Items List
                    [
                      ("LACTOGEN PRO 1 BIB 24x400g", "mcode_001"),
                      ("LACTOGEN PRO 2 BIB 24x400g", "mcode_002"),
                      ...
                      (700,000 items)
                    ]
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FUZZY MATCHING ENGINE (fuzzy_matcher.py)                    â”‚
â”‚                                                                           â”‚
â”‚  For each OCR product SKU:                                               â”‚
â”‚  1. Use RapidFuzz process.extract()                                      â”‚
â”‚  2. Apply token_set_ratio scorer                                         â”‚
â”‚  3. Find top 3 matches above 60% threshold                               â”‚
â”‚  4. Calculate confidence level                                           â”‚
â”‚                                                                           â”‚
â”‚  Algorithm: token_set_ratio                                              â”‚
â”‚  â€¢ Handles missing/extra words                                           â”‚
â”‚  â€¢ Tolerates typos and spacing                                           â”‚
â”‚  â€¢ Ignores word order                                                    â”‚
â”‚                                                                           â”‚
â”‚  Performance: 50-200ms per query (for 700k items)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                         Enhanced Products
                    [
                      {
                        "sku": "LACTOGEN PRO1...",
                        "quantity": 5,
                        "fuzzy_matches": [
                          {
                            "desca": "LACTOGEN PRO 1...",
                            "mcode": "mcode_001",
                            "score": 94.59,
                            "rank": 1
                          },
                          ...
                        ],
                        "best_match": {...},
                        "match_confidence": "high"
                      }
                    ]
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          API RESPONSE                                    â”‚
â”‚                                                                           â”‚
â”‚  Return complete JSON with:                                              â”‚
â”‚  â€¢ Original OCR data                                                     â”‚
â”‚  â€¢ Enhanced products with fuzzy matches                                  â”‚
â”‚  â€¢ Confidence scores                                                     â”‚
â”‚  â€¢ Match suggestions                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CLIENT DECISION LOGIC                               â”‚
â”‚                                                                           â”‚
â”‚  IF match_confidence == "high" (score â‰¥ 85):                             â”‚
â”‚    â†’ Auto-accept best_match.mcode                                        â”‚
â”‚                                                                           â”‚
â”‚  ELIF match_confidence in ["medium", "low"] (score 60-84):               â”‚
â”‚    â†’ Show fuzzy_matches to user for selection                            â”‚
â”‚                                                                           â”‚
â”‚  ELSE match_confidence == "none" (score < 60):                           â”‚
â”‚    â†’ Require manual entry                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Component Interaction Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   api.py     â”‚  â† Main FastAPI application
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   â”‚ db_connection.py â”‚  â† Database connectivity
       â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   â”‚ menu_cache.py    â”‚  â† Caching layer (1hr TTL)
       â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â””â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ fuzzy_matcher.py â”‚  â† RapidFuzz matching engine
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Cache Lifecycle

```
Request 1 (t=0s):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cache Empty     â”‚ â†’ Query DB (1-2s) â†’ Store in Cache â†’ Return data
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Request 2 (t=30s):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cache Valid     â”‚ â†’ Return from Cache (<1ms) â†’ Fast response
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Request 3 (t=3600s):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cache Expired   â”‚ â†’ Query DB (1-2s) â†’ Refresh Cache â†’ Return data
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Manual Invalidation:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST            â”‚
â”‚ /cache/         â”‚ â†’ Clear Cache â†’ Next request loads fresh data
â”‚ invalidate      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Fuzzy Matching Process Detail

```
Input: "LACTOGEN PRO1 BIB 24x400g INNWPB176 NP"
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RapidFuzz process.extract()                          â”‚
â”‚                                                       â”‚
â”‚ Compares against 700,000 menu items using:          â”‚
â”‚ â€¢ Scorer: token_set_ratio                           â”‚
â”‚ â€¢ Limit: Top 3 matches                              â”‚
â”‚ â€¢ Cutoff: Minimum 60% similarity                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
        Match Results (sorted by score)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rank 1: "LACTOGEN PRO 1 BIB 24x400g INNWPB176"      â”‚
â”‚         mcode_001, Score: 94.59                     â”‚
â”‚         â†‘ Best Match                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Rank 2: "LACTOGEN PRO 2 BIB 24x400g INLEB086"      â”‚
â”‚         mcode_002, Score: 72.35                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Rank 3: "LACTOGEN PRO 3 FOLLOW UP 400g"            â”‚
â”‚         mcode_003, Score: 65.12                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
              Confidence Classification
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Best match score: 94.59                             â”‚
â”‚ 94.59 â‰¥ 85 â†’ Confidence: "high"                     â”‚
â”‚                                                       â”‚
â”‚ Decision: Auto-accept mcode_001                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Performance Metrics Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     REQUEST TIMELINE                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  0ms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚               â”‚ Receive Request                              â”‚
â”‚  1ms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚               â”‚                                              â”‚
â”‚               â”‚ Check Cache                                  â”‚
â”‚               â”‚                                              â”‚
â”‚  2ms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€ Cache Hit? â”€â”¬â”€ YES â†’ <1ms                 â”‚
â”‚                                â”‚                             â”‚
â”‚                                â””â”€ NO  â†’ Query DB (1000-2000ms)â”‚
â”‚                                                               â”‚
â”‚  3ms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚               â”‚ Start Fuzzy Matching                         â”‚
â”‚               â”‚ (per product)                                â”‚
â”‚               â”‚                                              â”‚
â”‚  53ms â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Product 1 matched (50ms)                     â”‚
â”‚  103ms â”€â”€â”€â”€â”€â”€â”€ Product 2 matched (50ms)                      â”‚
â”‚  153ms â”€â”€â”€â”€â”€â”€â”€ Product 3 matched (50ms)                      â”‚
â”‚               â”‚                                              â”‚
â”‚  155ms â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚               â”‚ Build Response                               â”‚
â”‚  160ms â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚               â”‚                                              â”‚
â”‚  160ms â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚               â”‚ Return to Client                             â”‚
â”‚  165ms â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚                                                               â”‚
â”‚  TOTAL (Cache Hit):  ~160ms                                  â”‚
â”‚  TOTAL (Cache Miss): ~2000ms (first request only)            â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Structures

### Menu Items (Database)
```python
[
    ("LACTOGEN PRO 1 BIB 24x400g INNWPB176", "mcode_001"),
    ("LACTOGEN PRO 2 BIB 24x400g INLEB086", "mcode_002"),
    ...
    # 700,000 tuples (desca, mcode)
]
```

### OCR Products (Input)
```python
[
    {
        "sku": "LACTOGEN PRO1 BIB 24x400g INNWPB176 NP",
        "sku_code": "12579462",
        "quantity": 5,
        "rate": 872.82,
        "mrp": 15898.56
    },
    ...
]
```

### Enhanced Products (Output)
```python
[
    {
        "sku": "LACTOGEN PRO1 BIB 24x400g INNWPB176 NP",
        "sku_code": "12579462",
        "quantity": 5,
        "rate": 872.82,
        "mrp": 15898.56,
        
        # NEW: Fuzzy matching results
        "fuzzy_matches": [
            {
                "desca": "LACTOGEN PRO 1 BIB 24x400g INNWPB176",
                "mcode": "mcode_001",
                "score": 94.59,
                "rank": 1
            },
            ...
        ],
        "best_match": {...},
        "match_confidence": "high"
    },
    ...
]
```

---

## API Endpoints Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     API ENDPOINTS                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  GET /                                                        â”‚
â”‚  â””â”€â†’ Health check                                            â”‚
â”‚                                                               â”‚
â”‚  POST /extract                                                â”‚
â”‚  â”œâ”€â†’ Receive invoice file                                    â”‚
â”‚  â”œâ”€â†’ OCR with Gemini                                         â”‚
â”‚  â”œâ”€â†’ Fetch menu items (cached)                               â”‚
â”‚  â”œâ”€â†’ Apply fuzzy matching                                    â”‚
â”‚  â””â”€â†’ Return enhanced products                                â”‚
â”‚                                                               â”‚
â”‚  GET /cache/status                                            â”‚
â”‚  â””â”€â†’ {                                                        â”‚
â”‚        "cache": {                                             â”‚
â”‚          "status": "valid",                                   â”‚
â”‚          "item_count": 700000,                                â”‚
â”‚          "age_seconds": 1234.56,                              â”‚
â”‚          "expires_in": 2365.44                                â”‚
â”‚        }                                                      â”‚
â”‚      }                                                        â”‚
â”‚                                                               â”‚
â”‚  POST /cache/invalidate                                       â”‚
â”‚  â””â”€â†’ Force cache refresh                                     â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Error Handling Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ERROR SCENARIOS                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Database Connection Failed                                  â”‚
â”‚  â””â”€â†’ Raise HTTPException(500)                                â”‚
â”‚      â””â”€â†’ Log to tblOCRTokenDetails                           â”‚
â”‚                                                               â”‚
â”‚  OCR Extraction Failed                                       â”‚
â”‚  â””â”€â†’ Raise HTTPException(422)                                â”‚
â”‚      â””â”€â†’ Return error details                                â”‚
â”‚                                                               â”‚
â”‚  Cache Invalid                                               â”‚
â”‚  â””â”€â†’ Attempt DB query                                        â”‚
â”‚      â””â”€â†’ If fails, raise error                               â”‚
â”‚                                                               â”‚
â”‚  No Fuzzy Matches Found                                      â”‚
â”‚  â””â”€â†’ Return empty fuzzy_matches: []                          â”‚
â”‚      â””â”€â†’ match_confidence: "none"                            â”‚
â”‚      â””â”€â†’ Client handles manual entry                         â”‚
â”‚                                                               â”‚
â”‚  Low Confidence Match (60-69%)                               â”‚
â”‚  â””â”€â†’ Return matches with "low" confidence                    â”‚
â”‚      â””â”€â†’ Client shows for user review                        â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

This completes the visual documentation of your high-performance fuzzy matching system! ğŸ‰
